#!/usr/bin/perl

use strict;

#*CORE::GLOBAL::die = sub { require Carp; Carp::confess(); };
#$SIG{__WARN__} = sub { require Carp; Carp::confess(); };

use PrOCAV::Ingestion qw(create_workbook ingest_workbook);
use HTML::Template;
#use Apache2::FakeRequest;
use PrOCAV::API qw(handler);
use PrOCAV::Database qw(make_dbh all_records table_info insert_record insert_resource);
use PrOCAV::Resources qw(dbpedia_uri);
use Data::Dumper;

$Data::Dumper::Indent = 1;
$Data::Dumper::Terse = 1;

sub test_create_workbook {
    create_workbook({works => [1,2,3,4,5]});
}

sub test_ingest_workbook {
    ingest_workbook("../../test16.xlsx");
}

sub test_editor_front_page {
    make_dbh;

    my $template = HTML::Template->new(filename => "../web/editor/new_session.tmpl", global_vars => 1);

    # my $params = {tables => [{table_name => 'works',
    # 			      columns => [{column => 'ID'}, {column => 'uniform_title'}],
    # 			      records => [{ID => '1', fields => [{value => '1'}, {value => 'Helllo'}]}]},
    # 			     {table_name => 'dates',
    # 			      columns => [{column => 'ID'}, {column => 'year'}],
    # 			      records => [{ID => '16', fields => [{value => '16'}, {value => '1927'}]}]}]};

    # $template->param($params);
 
    my $field_order = [@{ table_info('works')->{_field_order} }];
    my $columns = [map { {column => $_}; } @$field_order];

    print Dumper($columns);
    print "\n\n";

    my $records = [];

    foreach my $work (@{ PrOCAV::Database::list_works() }) {
	my $fields = [];
	foreach my $fn (@$field_order) {
	    push $fields, {value => $work->{$fn}};
	}

	push $records, {ID => $work->{ID},
			#fields => map { {value => $work->{$_}}; } @{ table_info('works')->{_field_order} }};
			fields => $fields};
    }
    #my $_records = Database::list_works();
    #my @records = map { {ID => $_->{ID}, fields => map { {value => $_}; } @{ table_info('works')->{_field_order} } }; } @{ Database::list_works() };

    #print Dumper(@records);

    #for my $rec (@records) {
	#print Dumper($rec) . "\n";
	#print $rec->{ID} . "\n";
	#print Dumper($rec->{fields}) . "\n";
    #}

    my $param = {tables => [{table_name => 'works',
			     columns => $columns,
			     records => $records}]};
    print Dumper($param);
    print "\n\n";

    $template->param($param);
    print $template->output();
}

sub test_handler {
    my $r = Apache2::FakeRequest->new(hostname => 'localhost');
    handler($r);
}

sub test_database_autoloader {
    make_dbh;

    print 'PrOCAV::Database::work(1):'; print "\n";
    my $work_1 = PrOCAV::Database::work(1);
    print Dumper($work_1) . "\n";

    print 'PrOCAV::Database::list_works():'; print "\n";
    my $works = PrOCAV::Database::list_works();
    print scalar @$works . "\n";
    foreach my $work (@$works) {
	print $work->{uniform_title} . "\n";
    }

    print 'PrOCAV::Database::list("works"):'; print "\n";
    my $works = PrOCAV::Database::list("works");
    print scalar @$works . "\n";
    foreach my $work (@$works) {
	print $work->{uniform_title} . "\n";
    }

    my $musical_information_1 = PrOCAV::Database::musical_information(1);
    print Dumper($musical_information_1) . "\n";

    my $musical_information = PrOCAV::Database::list_musical_information();
    print scalar @$musical_information . "\n";
    foreach my $musical_information (@$musical_information) {
	print $musical_information->{work_id} . "\n";
    }

    my $catalogue_number_1 = PrOCAV::Database::catalogue_number(1);
    print Dumper($catalogue_number_1) . "\n";

    my $catalogue_numbers = PrOCAV::Database::list_catalogue_numbers();
    print scalar @$catalogue_numbers . "\n";
    foreach my $catalogue_number (@$catalogue_numbers) {
	print $catalogue_number->{number} . "\n";
    }
}

sub test_schema_statements {
    make_dbh;

    my $work = PrOCAV::Database::complete_work(55);
    print Dumper($work) . "\n\n";

    my $work = PrOCAV::Database::complete_work(56);
    print Dumper($work) . "\n\n";

    my $work = PrOCAV::Database::complete_work(57);
    print Dumper($work) . "\n\n";
}

sub test_all_records {
    print Dumper(all_records);
}

sub test_dbpedia_url {
    print dbpedia_uri("clarinet") . "\n";
}

sub test_insert_resource {
    make_dbh;
    insert_resource("insert", "works",
		    {ID => 139, uniform_title => "Ivan the Terrible"},
		    {uri => 'http://en.wikipedia.org/wiki/Ivan_the_Terrible_(Prokofiev)', mime_type => 'text/html'});
    insert_resource("insert", "works",
		    {ID => 44, uniform_title => "The Fiery Angel"},
		    {uri => 'http://en.wikipedia.org/wiki/The_Fiery_Angel_(opera)', mime_type => 'text/html'});
}

sub test_auto_resource_inserter {
    make_dbh;
    insert_record("instruments", {instrument => "xylophone"});
}

sub main {
    #test_create_workbook;
    #test_ingest_workbook;
    #test_editor_front_page;
    #test_handler;
    #test_database_autoloader;
    #test_all_records;
    #test_dbpedia_url;
    #test_insert_resource;
    #test_auto_resource_inserter;
    test_schema_statements;
}

main;
